<app-header></app-header>
<div class="mapa-container">
  <!-- Encabezado con filtros -->
  <div class="mapa-header">
    <h2>🌿 Mapa de Biodiversidad Ecuador</h2>

    <div class="filtros">
      <div class="filter-group">
        <label for="provincia-select">Provincia:</label>
        <select
          id="provincia-select"
          [(ngModel)]="provinciaSeleccionada"
          (change)="onProvinciaChange(provinciaSeleccionada)"
          class="form-select">
          <option value="Todas">Todas las provincias</option>

          <optgroup label="Costa">
            <option value="Esmeraldas">Esmeraldas</option>
            <option value="Manabí">Manabí</option>
            <option value="Los Ríos">Los Ríos</option>
            <option value="Guayas">Guayas</option>
            <option value="Santa Elena">Santa Elena</option>
            <option value="El Oro">El Oro</option>
            <option value="Santo Domingo">Santo Domingo de los Tsáchilas</option>
          </optgroup>

          <optgroup label="Sierra">
            <option value="Carchi">Carchi</option>
            <option value="Imbabura">Imbabura</option>
            <option value="Pichincha">Pichincha</option>
            <option value="Cotopaxi">Cotopaxi</option>
            <option value="Tungurahua">Tungurahua</option>
            <option value="Bolívar">Bolívar</option>
            <option value="Chimborazo">Chimborazo</option>
            <option value="Cañar">Cañar</option>
            <option value="Azuay">Azuay</option>
            <option value="Loja">Loja</option>
          </optgroup>

          <optgroup label="Oriente">
            <option value="Sucumbíos">Sucumbíos</option>
            <option value="Orellana">Orellana</option>
            <option value="Napo">Napo</option>
            <option value="Pastaza">Pastaza</option>
            <option value="Morona Santiago">Morona Santiago</option>
            <option value="Zamora Chinchipe">Zamora Chinchipe</option>
          </optgroup>

          <optgroup label="Región Insular">
            <option value="Galápagos">Galápagos</option>
          </optgroup>
        </select>
      </div>

      <div class="especies-count">
        <span class="badge">{{ especiesFiltradas.length }} especies encontradas</span>
        <span class="province-badge" *ngIf="provinciaSeleccionada !== 'Todas'">
          en {{ provinciaSeleccionada }}
        </span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos del mapa...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !isLoading" class="error-container">
    <p>{{ error }}</p>
    <button (click)="cargarEspecies()" class="btn btn-retry">🔄 Reintentar</button>
  </div>

  <!-- Mapa principal -->
  <div class="mapa-content" *ngIf="!isLoading && !error">
    <google-map
      [options]="mapOptions"
      [width]="'100%'"
      [height]="'700px'">

      <!-- Markers de especies -->
      <map-marker
        *ngFor="let marker of markers"
        [position]="marker.position"
        [title]="marker.title"
        [options]="marker.options"
        (mapClick)="onMarkerClick(marker)">
      </map-marker>
    </google-map>

    <!-- Leyenda -->
    <div class="leyenda">
      <h4>Estado de Conservación</h4>

      <div class="leyenda-item">
        <span class="marker-dot rojo"></span>
        <span>Peligro Crítico</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot naranja"></span>
        <span>En Peligro</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot amarillo"></span>
        <span>Casi Amenazado</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot azul"></span>
        <span>Vulnerable</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot verde"></span>
        <span>Preocupación Menor</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot rosado"></span>
        <span>Extinto</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot morado"></span>
        <span>Datos Insuficientes</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot gris"></span>
        <span>No Evaluado</span>
      </div>
    </div>
  </div>

  <!-- Panel de información de especie seleccionada -->
  <div *ngIf="especieSeleccionada" class="especie-info-panel">
    <div class="panel-header">
      <h3>{{ especieSeleccionada.nombre_vulgar }}</h3>
      <button (click)="cerrarInfoEspecie()" class="btn-close">&times;</button>
    </div>

    <div class="panel-content">
      <div class="especie-details">
        <p><strong>Nombre científico:</strong> {{ especieSeleccionada.nombre_cientifico }}</p>
        <p><strong>Familia:</strong> {{ especieSeleccionada.familia }}</p>
        <p><strong>Hábitat:</strong> {{ especieSeleccionada.habitat }}</p>
        <p><strong>Estado:</strong>
          <span class="status-badge" [style.background-color]="getStatusColor(especieSeleccionada.estado_conservacion)">
            {{ especieSeleccionada.estado_conservacion }}
          </span>
        </p>
        <p *ngIf="especieSeleccionada.descripcion"><strong>Descripción:</strong> {{ especieSeleccionada.descripcion }}</p>
        <p><strong>Provincia:</strong>
          {{ determinarProvinciaPorCoordenadas(especieSeleccionada.coordenadas.latitud, especieSeleccionada.coordenadas.longitud) }}
        </p>
        <p><strong>Coordenadas:</strong>
          {{ especieSeleccionada.coordenadas.latitud.toFixed(4) }},
          {{ especieSeleccionada.coordenadas.longitud.toFixed(4) }}
        </p>
      </div>
    </div>
  </div>

  <!-- GRÁFICO DE PASTEL (al final) -->
  <div class="estadisticas-seccion" *ngIf="!isLoading && !error && especies.length > 0">
    <div class="estadisticas-header">
      <h3> Distribución por Estado de Conservación</h3>
      <p class="estadisticas-subtitle">Análisis de {{ totalEspecies }} especies registradas en Ecuador</p>
    </div>

    <div class="grafico-container">
      <!-- Gráfico de pastel -->
      <div class="pie-chart-wrapper">
        <svg class="pie-chart" viewBox="0 0 200 200" [style.width.px]="280" [style.height.px]="280">
          <!-- Círculo base -->
          <circle cx="100" cy="100" r="85" fill="transparent" stroke="#f0f0f0" stroke-width="2"></circle>

          <!-- Segmentos del gráfico -->
          <g *ngFor="let segmento of segmentosPastel; let i = index">
            <path
              [attr.d]="segmento.path"
              [attr.fill]="segmento.color"
              [attr.stroke]="'#ffffff'"
              [attr.stroke-width]="3"
              class="pie-segment"
              [attr.data-tooltip]="segmento.estado + ': ' + segmento.cantidad + ' especies (' + segmento.porcentaje.toFixed(1) + '%)'">
            </path>
          </g>

          <!-- Círculo central para hacer efecto donut -->
          <circle cx="100" cy="100" r="40" fill="white" stroke="#e0e0e0" stroke-width="3"></circle>

          <!-- Texto central -->
          <text x="100" y="92" text-anchor="middle" class="chart-total-label">TOTAL</text>
          <text x="100" y="108" text-anchor="middle" class="chart-total-number">{{ totalEspecies }}</text>
          <text x="100" y="120" text-anchor="middle" class="chart-total-subtitle">especies</text>
        </svg>
      </div>

      <!-- Leyenda del gráfico -->
      <div class="chart-legend">
        <h4>Estados de Conservación</h4>
        <div class="legend-list">
          <div *ngFor="let item of estadisticasConservacion"
               class="legend-item"
               [class.legend-item-highlight]="item.cantidad > 0">
            <div class="legend-color-box" [style.background-color]="item.color"></div>
            <div class="legend-info">
              <span class="legend-label">{{ item.estado }}</span>
              <div class="legend-stats">
                <span class="legend-count">{{ item.cantidad }}</span>
                <span class="legend-percentage">{{ item.porcentaje.toFixed(1) }}%</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Resumen estadístico -->
      </div>
    </div>
  </div>
</div>
