<app-header></app-header>
<div class="mapa-container">
  <!-- Encabezado con filtros -->
  <div class="mapa-header">
    <h2>üåø Mapa de Biodiversidad Ecuador</h2>

    <div class="filtros">
      <div class="filter-group">
        <label for="provincia-select">Provincia:</label>
        <select
          id="provincia-select"
          [(ngModel)]="provinciaSeleccionada"
          (change)="onProvinciaChange(provinciaSeleccionada)"
          class="form-select">
          <option value="Todas">Todas las provincias</option>

          <!-- ‚úÖ COSTA -->
          <optgroup label="Costa">
            <option value="Esmeraldas">Esmeraldas</option>
            <option value="Manab√≠">Manab√≠</option>
            <option value="Los R√≠os">Los R√≠os</option>
            <option value="Guayas">Guayas</option>
            <option value="Santa Elena">Santa Elena</option>
            <option value="El Oro">El Oro</option>
            <option value="Santo Domingo">Santo Domingo de los Ts√°chilas</option>
          </optgroup>

          <!-- ‚úÖ SIERRA -->
          <optgroup label="Sierra">
            <option value="Carchi">Carchi</option>
            <option value="Imbabura">Imbabura</option>
            <option value="Pichincha">Pichincha</option>
            <option value="Cotopaxi">Cotopaxi</option>
            <option value="Tungurahua">Tungurahua</option>
            <option value="Bol√≠var">Bol√≠var</option>
            <option value="Chimborazo">Chimborazo</option>
            <option value="Ca√±ar">Ca√±ar</option>
            <option value="Azuay">Azuay</option>
            <option value="Loja">Loja</option>
          </optgroup>

          <!-- ‚úÖ ORIENTE -->
          <optgroup label="Oriente">
            <option value="Sucumb√≠os">Sucumb√≠os</option>
            <option value="Orellana">Orellana</option>
            <option value="Napo">Napo</option>
            <option value="Pastaza">Pastaza</option>
            <option value="Morona Santiago">Morona Santiago</option>
            <option value="Zamora Chinchipe">Zamora Chinchipe</option>
          </optgroup>

          <!-- ‚úÖ INSULAR -->
          <optgroup label="Regi√≥n Insular">
            <option value="Gal√°pagos">Gal√°pagos</option>
          </optgroup>
        </select>
      </div>

      <div class="especies-count">
        <span class="badge">{{ especiesFiltradas.length }} especies encontradas</span>
        <span class="province-badge" *ngIf="provinciaSeleccionada !== 'Todas'">
          en {{ provinciaSeleccionada }}
        </span>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="spinner"></div>
    <p>Cargando datos del mapa...</p>
  </div>

  <!-- Error -->
  <div *ngIf="error && !isLoading" class="error-container">
    <p>{{ error }}</p>
    <button (click)="cargarEspecies()" class="btn btn-retry">üîÑ Reintentar</button>
  </div>

  <!-- Mapa principal -->
  <div class="mapa-content" *ngIf="!isLoading && !error">
    <google-map
      [options]="mapOptions"
      [width]="'100%'"
      [height]="'600px'">

      <!-- Markers de especies -->
      <map-marker
        *ngFor="let marker of markers"
        [position]="marker.position"
        [title]="marker.title"
        [options]="marker.options"
        (mapClick)="onMarkerClick(marker)">
      </map-marker>
    </google-map>

    <!-- Leyenda -->
    <div class="leyenda">
      <h4>Estado de Conservaci√≥n</h4>

      <div class="leyenda-item">
        <span class="marker-dot rojo"></span>
        <span>Peligro Cr√≠tico</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot naranja"></span>
        <span>En Peligro</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot amarillo"></span>
        <span>Casi Amenazado</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot azul"></span>
        <span>Vulnerable</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot verde"></span>
        <span>Preocupaci√≥n Menor</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot rosado"></span>
        <span>Extinto</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot morado"></span>
        <span>Datos Insuficientes</span>
      </div>

      <div class="leyenda-item">
        <span class="marker-dot gris"></span>
        <span>No Evaluado</span>
      </div>
    </div>
  </div>

  <!-- Panel de informaci√≥n de especie seleccionada -->
  <div *ngIf="especieSeleccionada" class="especie-info-panel">
    <div class="panel-header">
      <h3>{{ especieSeleccionada.nombre_vulgar }}</h3>
      <button (click)="cerrarInfoEspecie()" class="btn-close">&times;</button>
    </div>

    <div class="panel-content">
      <div class="especie-details">
        <p><strong>Nombre cient√≠fico:</strong> {{ especieSeleccionada.nombre_cientifico }}</p>
        <p><strong>Familia:</strong> {{ especieSeleccionada.familia }}</p>
        <p><strong>H√°bitat:</strong> {{ especieSeleccionada.habitat }}</p>
        <p><strong>Estado:</strong>
          <span class="status-badge" [style.background-color]="getStatusColor(especieSeleccionada.estado_conservacion)">
            {{ especieSeleccionada.estado_conservacion }}
          </span>
        </p>
        <p *ngIf="especieSeleccionada.descripcion"><strong>Descripci√≥n:</strong> {{ especieSeleccionada.descripcion }}</p>
        <p><strong>Provincia:</strong>
          {{ determinarProvinciaPorCoordenadas(especieSeleccionada.coordenadas.latitud, especieSeleccionada.coordenadas.longitud) }}
        </p>
        <p><strong>Coordenadas:</strong>
          {{ especieSeleccionada.coordenadas.latitud.toFixed(4) }},
          {{ especieSeleccionada.coordenadas.longitud.toFixed(4) }}
        </p>
      </div>
    </div>
  </div>
</div>
